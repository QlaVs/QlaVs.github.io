<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vk_log_in</title>
	
    <script type="text/javascript" src="jquery-3.5.1.js"></script>
	
</head>
<body>
<h2>Получение списка друзей и имени</h2>

<script type="text/javascript" src="https://vk.com/js/api/openapi.js?168"></script>
<h2>
<div class="text-center">
	<a role="button" href="https://oauth.vk.com/authorize?client_id=7534918&redirect_uri=QlaVs.github.io/Test_Auth&scope=friends&response_type=token&v=5.52" id="btn">Авторизоваться</a>
</div>
</h2>

<ul></ul>

<script>
	
    if(location.hash.indexOf("#access_token=")===0){
        localStorage.token = location.hash.substring(14,99);
        localStorage.session = Date.now() + 86400;
        location.hash = "";
    }

    if(Date.now() <= parseInt(localStorage.session)){
		$("#btn").hide();
		send('friends.search',{count:5}, function (data) {
			render(data.response);
		});
		send('users.get',{}, function (data) {
			//render
			render(data.response);
			const btn = '<button type="button" onclick="localStorage.clear(); location.reload();">Выйти</button>';
			$('#username').html('Имя: ' + data.response[0].first_name + btn).show();
		});
    }

    /**
     * @return {string}
     */
    function URL (method, params) {
	    if (!method) throw new Error('Method not found');
	    params = params || {};
	    params['access_token'] = localStorage.token;
		return "https://api.vk.com/method/" + method + '?' + $.param(params);
    }

	function send(method, params, callback) {
		$.ajax({
			url: URL(method, params),
			method: "GET",
			dataType: "JSONP",
			success: callback
		});
    }

    function render(response) {
        var html = '';
        for(var i = 1; i < response.length; i++){
            var f = response[i];
            html += '<li>' +
					'<a target="_blank" href="vk.com/id"' + f.uid + '>'+
						'<div>'+
							'<h4>' + f.first_name + ' ' + f.last_name + '</h4>'+
						'</div>'+
					'</a>'+
					'</li>';
        }
		console.log(html);
        $('ul').html(html);
    }
</script>
</body>
</html>